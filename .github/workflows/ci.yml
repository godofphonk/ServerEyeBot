# ServerEye Bot CI Pipeline

name: CI

on:
  push:
    branches: [ master, main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    name: Build and Test Bot
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-
            ${{ runner.os }}-go-
      
      - name: Download dependencies
        run: go mod download
      
      - name: Build bot
        run: go build -v ./cmd/bot
      
      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running bot tests..."
          rm -f coverage.txt
          go test -short -race -coverprofile=coverage.txt -covermode=atomic ./...
      
      - name: Show detailed coverage
        run: |
          echo "ðŸ“Š Coverage Report by Module:"
          echo "=============================="
          go tool cover -func=coverage.txt | grep -E "internal/bot|^total:" || true
          echo ""
          echo "ðŸ“ˆ Total Coverage:"
          go tool cover -func=coverage.txt | grep "^total:" || echo "Coverage report generated"
      
      - name: Check coverage threshold
        continue-on-error: true
        run: |
          COVERAGE=$(go tool cover -func=coverage.txt | grep "^total:" | awk '{print $3}' | sed 's/%//' || echo "0")
          echo "Current coverage: ${COVERAGE}%"
          THRESHOLD=40
          RESULT=$(awk -v cov="$COVERAGE" -v thr="$THRESHOLD" 'BEGIN { print (cov >= thr) ? "OK" : "FAIL" }')
          if [ "$RESULT" = "FAIL" ]; then
            echo "âš ï¸  Coverage ${COVERAGE}% is below ${THRESHOLD}% threshold (warning only)"
          else
            echo "âœ… Coverage ${COVERAGE}% meets threshold"
          fi
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.txt
          fail_ci_if_error: false

  module-tests:
    name: Module Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        module:
          - internal/bot
          - internal/config
          - pkg/protocol
          - pkg/redis
          - pkg/kafka
          - pkg/publisher
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Test ${{ matrix.module }}
        run: |
          echo "ðŸ§ª Testing ${{ matrix.module }}..."
          go test -v -short -cover ./${{ matrix.module }}/...

  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Run Gosec Security Scanner
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          echo "ðŸ”’ Running security scan..."
          gosec -fmt=text ./... || echo "âš ï¸ Security issues found (non-blocking)"

  vulnerability-check:
    name: Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      
      - name: Download dependencies
        run: go mod download
      
      - name: Check for vulnerabilities
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
      
      - name: Check for outdated dependencies
        continue-on-error: true
        run: |
          echo "ðŸ“¦ Checking dependencies..."
          go list -u -m all

  docker-build-dev:
    name: Build DEV Bot Image
    runs-on: ubuntu-latest
    needs: [build, lint]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push DEV Bot image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile.bot
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/servereye-bot:dev
            ghcr.io/${{ github.repository_owner }}/servereye-bot:dev-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: DEV Summary
        run: |
          echo "ðŸ§ª DEV bot image published:"
          echo "ðŸ¤– Bot: ghcr.io/${{ github.repository_owner }}/servereye-bot:dev"
          echo ""
          echo "âš¡ DEV bot will auto-update in ~1 minute!"

  docker-build-prod:
    name: Build PROD Bot Image
    runs-on: ubuntu-latest
    needs: [build, lint]
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Build and push PROD Bot image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployments/Dockerfile.bot
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/servereye-bot:stable
            ghcr.io/${{ github.repository_owner }}/servereye-bot:latest
            ghcr.io/${{ github.repository_owner }}/servereye-bot:${{ steps.version.outputs.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: PROD Summary
        run: |
          echo "ðŸš€ PRODUCTION bot image published:"
          echo "ðŸ¤– Bot: ghcr.io/${{ github.repository_owner }}/servereye-bot:stable"
          echo "ðŸ¤– Bot: ghcr.io/${{ github.repository_owner }}/servereye-bot:latest"
          echo "ðŸ¤– Bot: ghcr.io/${{ github.repository_owner }}/servereye-bot:${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "âœ… PROD bot will update to stable version!"
