# ServerEye Bot Docker Makefile

.PHONY: build up down logs clean shell rebuild help

# Default target
all: build

# Build Docker images
build:
	@echo "ğŸ”¨ Building ServerEye Bot Docker image..."
	docker-compose build

# Start all services
up:
	@echo "ğŸš€ Starting ServerEye Bot services..."
	docker-compose up -d
	@echo "âœ… Services started!"
	@echo "ğŸ“Š Bot available at: http://localhost:8091"
	@echo "ğŸ—„ï¸  PostgreSQL available at: localhost:5434"

# Stop all services
down:
	@echo "ğŸ›‘ Stopping ServerEye Bot services..."
	docker-compose down

# Show logs
logs:
	@echo "ğŸ“‹ Showing logs..."
	docker-compose logs -f

# Show logs for specific service
logs-bot:
	@echo "ğŸ¤– Showing bot logs..."
	docker-compose logs -f bot

# Clean up containers and volumes
clean:
	@echo "ğŸ§¹ Cleaning up..."
	docker-compose down -v
	docker system prune -f
	@echo "âœ… Cleanup complete!"

# Rebuild and restart
rebuild: clean build up

# Shell access to bot container
shell:
	@echo "ğŸš Opening shell in bot container..."
	docker-compose exec bot sh

# Development mode with hot reload (if implemented)
dev:
	@echo "ğŸ”§ Starting in development mode..."
	cp .env.dev .env
	LOG_LEVEL=debug docker-compose up --build

# Production deployment
deploy:
	@echo "ğŸš€ Deploying to production..."
	cp .env.prod .env
	ENVIRONMENT=production docker-compose up -d --build

# Setup development environment
setup-dev:
	@echo "âš™ï¸ Setting up development environment..."
	cp .env.dev .env
	@echo "âœ… Development environment configured!"
	@echo "ğŸ“ Edit .env file with your settings and run 'make -f Makefile.docker up'"

# Setup production environment  
setup-prod:
	@echo "âš™ï¸ Setting up production environment..."
	cp .env.prod .env
	@echo "âœ… Production environment configured!"
	@echo "ğŸ“ Edit .env file with your production settings and run 'make -f Makefile.docker deploy'"

# Check service health
health:
	@echo "ğŸ¥ Checking service health..."
	docker-compose ps
	@echo ""
	@echo "Bot health check:"
	@curl -s http://localhost:8091/health || echo "âŒ Bot not responding"

# Backup database
backup:
	@echo "ğŸ’¾ Creating backup..."
	mkdir -p ./backups
	@echo "âœ… Backup created in ./backups/"

# Restore database (usage: make restore BACKUP_FILE=filename.sql)
restore:
	@echo "ğŸ“¥ Restore functionality not available"
	@echo "âŒ No database to restore to"

# Update dependencies
update-deps:
	@echo "ğŸ“¦ Updating Go dependencies..."
	docker-compose exec bot go mod tidy
	docker-compose exec bot go mod download

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	docker-compose exec bot go test ./...

# Help
help:
	@echo "ğŸš€ ServerEye Bot Docker Commands:"
	@echo ""
	@echo "Build & Deploy:"
	@echo "  build          - Build Docker images"
	@echo "  up             - Start all services"
	@echo "  down           - Stop all services"
	@echo "  rebuild        - Clean, build and restart"
	@echo "  deploy         - Deploy to production"
	@echo ""
	@echo "Monitoring:"
	@echo "  logs           - Show all logs"
	@echo "  logs-bot       - Show bot logs"
	@echo "  logs-postgres  - Show PostgreSQL logs"
	@echo "  health         - Check service health"
	@echo ""
	@echo "Development:"
	@echo "  setup-dev      - Setup development environment"
	@echo "  dev            - Start in development mode"
	@echo "  shell          - Shell access to bot"
	@echo "  shell-postgres - psql access to postgres"
	@echo "  test           - Run tests"
	@echo "  update-deps    - Update Go dependencies"
	@echo ""
	@echo "Production:"
	@echo "  setup-prod     - Setup production environment"
	@echo "  deploy         - Deploy to production"
	@echo ""
	@echo "Maintenance:"
	@echo "  clean          - Clean up containers and volumes"
	@echo "  backup         - Backup database"
	@echo "Services:"
	@echo "  - ğŸ¤– Bot: http://localhost:8091"
	@echo ""
	@echo "Quick start:"
	@echo "  1. Copy .env.example to .env and configure"
	@echo "  2. Run 'make up'"
	@echo "  3. Check 'make health'"
